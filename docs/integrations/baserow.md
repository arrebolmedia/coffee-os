# Baserow - Base de Datos No-Code para CoffeeOS

## üéØ Objetivo

Baserow funciona como la **base de datos operativa principal** de CoffeeOS, proporcionando una interfaz no-code para que usuarios no t√©cnicos puedan gestionar datos cr√≠ticos del negocio mientras mantienen la integridad y relaciones necesarias.

## üìä Arquitectura de Datos

### Base Principal: `CoffeeOS Core`

El schema de Baserow replica y extiende el schema de Prisma, con campos espec√≠ficos optimizados para la interfaz no-code:

## üè¢ Tablas Core

### **Organizations** (Organizaciones)

- `name` (text) - Nombre de la organizaci√≥n
- `slug` (text) - Identificador √∫nico URL-friendly
- `description` (long text) - Descripci√≥n
- `timezone` (single select) - Zona horaria (America/Mexico_City, etc.)
- `active` (boolean) - Estado activo

### **Locations** (Ubicaciones/Tiendas)

- `organization` (link ‚Üí Organizations)
- `name` (text) - Nombre de la tienda
- `address` (long text) - Direcci√≥n completa
- `city` (text) - Ciudad
- `state` (single select) - Estado (CDMX, Jalisco, etc.)
- `postal_code` (text) - C√≥digo postal
- `phone` (phone) - Tel√©fono de la tienda
- `email` (email) - Email de contacto
- `timezone` (single select) - Zona horaria local
- `tax_rate` (number) - Tasa de impuesto (0.16 para M√©xico)
- `currency` (single select) - Moneda (MXN, USD)
- `active` (boolean) - Estado activo

### **Users** (Usuarios)

- `organization` (link ‚Üí Organizations)
- `role` (link ‚Üí Roles)
- `locations` (link ‚Üí Locations multi) - Ubicaciones asignadas
- `email` (email) - Email √∫nico
- `first_name` (text) - Nombre
- `last_name` (text) - Apellido
- `phone` (phone) - Tel√©fono
- `avatar` (file) - Foto de perfil
- `email_verified` (date) - Fecha verificaci√≥n email
- `two_factor_enabled` (boolean) - 2FA habilitado
- `last_login_at` (date) - √öltimo login
- `active` (boolean) - Estado activo

### **Roles** (Roles del Sistema)

- `name` (single select) - Propietario, Gerente, L√≠der de barra, Barista, Caja, Auditor, Contador
- `description` (long text) - Descripci√≥n del rol
- `scopes` (long text) - Permisos JSON (pos, inventory, reports, etc.)
- `active` (boolean) - Estado activo

## üõçÔ∏è Cat√°logo de Productos

### **Categories** (Categor√≠as)

- `name` (text) - Nombre de la categor√≠a
- `description` (long text) - Descripci√≥n
- `color` (text) - Color hex para UI
- `icon` (text) - √çcono (emoji o c√≥digo)
- `sort_order` (number) - Orden de presentaci√≥n
- `active` (boolean) - Estado activo

### **Products** (Productos)

- `category` (link ‚Üí Categories)
- `sku` (text) - C√≥digo √∫nico de producto
- `name` (text) - Nombre del producto
- `description` (long text) - Descripci√≥n
- `image` (file) - Imagen del producto
- `price` (number) - Precio de venta
- `cost` (number) - Costo base
- `tax_rate` (number) - Tasa de impuesto espec√≠fica
- `allow_modifiers` (boolean) - Permite modificadores
- `track_inventory` (boolean) - Seguimiento de inventario
- `active` (boolean) - Estado activo

### **Modifiers** (Modificadores)

- `name` (text) - Nombre del modificador
- `type` (single select) - SIZE, MILK, EXTRA, SYRUP, DECAF
- `price_delta` (number) - Diferencia de precio (+/-)
- `active` (boolean) - Estado activo

### **ProductModifiers** (Relaci√≥n Productos-Modificadores)

- `product` (link ‚Üí Products)
- `modifier` (link ‚Üí Modifiers)

## ‚òï Recetas y Costeo

### **Recipes** (Recetas)

- `product` (link ‚Üí Products)
- `name` (text) - Nombre de la receta
- `description` (long text) - Descripci√≥n detallada
- `instructions` (long text) - Instrucciones paso a paso
- `yield` (number) - Rendimiento (porciones)
- `yield_unit` (single select) - Unidad (ml, g, unit)
- `prep_time` (number) - Tiempo preparaci√≥n (segundos)
- `allergens` (multiple select) - Al√©rgenos (gluten, lactosa, frutos secos)
- `video_url` (url) - URL del video tutorial
- `version` (number) - Versi√≥n de la receta
- `active` (boolean) - Estado activo
- `cost_calculated` (formula) - Costo total autom√°tico

### **InventoryItems** (Art√≠culos de Inventario)

- `code` (text) - C√≥digo √∫nico
- `name` (text) - Nombre del art√≠culo
- `description` (long text) - Descripci√≥n
- `unit_of_measure` (single select) - ml, g, unit, kg, l
- `cost_per_unit` (number) - Costo por unidad
- `par_level` (number) - Nivel m√≠nimo
- `reorder_point` (number) - Punto de reorden
- `category` (single select) - Caf√©, Leche, Endulzantes, etc.
- `supplier` (link ‚Üí Suppliers)
- `active` (boolean) - Estado activo

### **RecipeIngredients** (Ingredientes por Receta)

- `recipe` (link ‚Üí Recipes)
- `inventory_item` (link ‚Üí InventoryItems)
- `quantity` (number) - Cantidad necesaria
- `unit` (text) - Unidad espec√≠fica
- `notes` (text) - Notas especiales
- `cost_line` (formula) - quantity √ó inventory_item.cost_per_unit

## üì¶ Gesti√≥n de Inventario

### **Suppliers** (Proveedores)

- `name` (text) - Nombre del proveedor
- `contact_name` (text) - Nombre de contacto
- `email` (email) - Email de contacto
- `phone` (phone) - Tel√©fono
- `address` (long text) - Direcci√≥n
- `payment_terms` (single select) - Contado, 15 d√≠as, 30 d√≠as
- `lead_time` (number) - Tiempo de entrega (d√≠as)
- `active` (boolean) - Estado activo

### **PurchaseOrders** (√ìrdenes de Compra)

- `location` (link ‚Üí Locations)
- `supplier` (link ‚Üí Suppliers)
- `po_number` (text) - N√∫mero de OC
- `status` (single select) - DRAFT, SENT, CONFIRMED, PARTIAL, RECEIVED, CANCELED
- `order_date` (date) - Fecha de orden
- `expected_date` (date) - Fecha esperada
- `received_date` (date) - Fecha recibida
- `subtotal` (formula) - Suma de l√≠neas
- `tax` (formula) - Impuestos calculados
- `total` (formula) - Total final
- `notes` (long text) - Notas adicionales

### **Lots** (Lotes)

- `code` (text) - C√≥digo de lote
- `expiration_date` (date) - Fecha de vencimiento
- `documents` (file multiple) - Documentos adjuntos

### **InventoryMovements** (Movimientos de Inventario)

- `location` (link ‚Üí Locations)
- `inventory_item` (link ‚Üí InventoryItems)
- `type` (single select) - IN, OUT, ADJUSTMENT, TRANSFER
- `quantity` (number) - Cantidad (+/-)
- `unit_cost` (number) - Costo unitario
- `lot` (link ‚Üí Lots)
- `reason` (single select) - Purchase, Sale, Recipe, Waste, etc.
- `reference` (text) - Referencia (ticket, PO, etc.)
- `notes` (text) - Notas
- `movement_date` (date) - Fecha del movimiento

## üè™ Punto de Venta

### **Tickets** (Ventas)

- `location` (link ‚Üí Locations)
- `user` (link ‚Üí Users) - Cajero
- `customer` (link ‚Üí Customers)
- `ticket_number` (text) - N√∫mero de ticket
- `status` (single select) - OPEN, CLOSED, REFUNDED, VOIDED
- `subtotal` (formula) - Suma de l√≠neas
- `tax` (formula) - Impuestos
- `tip` (number) - Propina
- `discount` (number) - Descuento
- `total` (formula) - Total final
- `opened_at` (date) - Fecha/hora apertura
- `closed_at` (date) - Fecha/hora cierre
- `notes` (text) - Notas

### **TicketLines** (L√≠neas de Venta)

- `ticket` (link ‚Üí Tickets)
- `product` (link ‚Üí Products)
- `quantity` (number) - Cantidad
- `unit_price` (number) - Precio unitario
- `discount` (number) - Descuento l√≠nea
- `total` (formula) - quantity √ó unit_price - discount
- `modifiers` (link ‚Üí Modifiers multi) - Modificadores aplicados
- `notes` (text) - Notas especiales

### **Payments** (Pagos)

- `ticket` (link ‚Üí Tickets)
- `method` (single select) - CASH, CARD, DIGITAL_WALLET, BANK_TRANSFER, LOYALTY_POINTS
- `amount` (number) - Monto pagado
- `reference` (text) - Referencia del pago
- `processor_data` (long text) - JSON con datos del procesador
- `processed_at` (date) - Fecha/hora procesamiento

## üë• CRM y Lealtad

### **Customers** (Clientes)

- `email` (email) - Email √∫nico
- `phone` (phone) - Tel√©fono √∫nico
- `first_name` (text) - Nombre
- `last_name` (text) - Apellido
- `birthday` (date) - Fecha de nacimiento
- `loyalty_points` (number) - Puntos acumulados
- `total_spent` (rollup) - Total gastado hist√≥rico
- `visit_count` (rollup) - N√∫mero de visitas
- `rfm_bucket` (single select) - Champions, Loyal, Potential, New, At Risk, Lost
- `last_visit` (rollup) - √öltima fecha de visita
- `preferences` (long text) - Preferencias JSON
- `active` (boolean) - Estado activo

### **Consents** (Consentimientos LFPDPPP)

- `customer` (link ‚Üí Customers)
- `type` (single select) - MARKETING_EMAIL, MARKETING_SMS, MARKETING_WHATSAPP, DATA_PROCESSING, COOKIES
- `granted` (boolean) - Consentimiento otorgado
- `source` (single select) - Web, App, Tienda, Llamada
- `ip_address` (text) - IP de origen
- `granted_at` (date) - Fecha de otorgamiento
- `revoked_at` (date) - Fecha de revocaci√≥n

### **Campaigns** (Campa√±as de Marketing)

- `name` (text) - Nombre de la campa√±a
- `type` (single select) - Birthday, Welcome, Winback, Promotion
- `segment` (single select) - All, RFM segments, Custom
- `channel` (multiple select) - Email, SMS, WhatsApp, In-store
- `status` (single select) - DRAFT, SCHEDULED, RUNNING, COMPLETED, PAUSED
- `schedule_date` (date) - Fecha programada
- `content` (long text) - Contenido del mensaje
- `sent_count` (number) - Enviados
- `open_rate` (number) - Tasa de apertura
- `click_rate` (number) - Tasa de click
- `conversion_rate` (number) - Tasa de conversi√≥n

## ‚úÖ Calidad y Cumplimiento

### **Checklists** (Listas de Verificaci√≥n)

- `name` (text) - Nombre del checklist
- `description` (long text) - Descripci√≥n
- `scope` (single select) - OPENING, CLOSING, MID_SHIFT, NOM_251, SAFETY, MAINTENANCE
- `frequency` (single select) - daily, weekly, monthly, on-demand
- `active` (boolean) - Estado activo

### **ChecklistItems** (Elementos del Checklist)

- `checklist` (link ‚Üí Checklists)
- `label` (text) - Etiqueta del elemento
- `description` (long text) - Descripci√≥n detallada
- `type` (single select) - BOOLEAN, NUMBER, TEMPERATURE, PHOTO, SIGNATURE, TEXT
- `required` (boolean) - Requerido
- `sort_order` (number) - Orden de presentaci√≥n
- `min_value` (number) - Valor m√≠nimo (para n√∫meros/temperaturas)
- `max_value` (number) - Valor m√°ximo
- `unit` (text) - Unidad (¬∞C, ppm, etc.)
- `active` (boolean) - Estado activo

### **TaskRuns** (Ejecuciones de Checklist)

- `checklist` (link ‚Üí Checklists)
- `location` (link ‚Üí Locations)
- `user` (link ‚Üí Users) - Usuario ejecutor
- `status` (single select) - IN_PROGRESS, COMPLETED, FAILED, CANCELED
- `started_at` (date) - Fecha/hora inicio
- `completed_at` (date) - Fecha/hora completado
- `notes` (text) - Notas generales
- `evidence` (file multiple) - Evidencia fotogr√°fica

### **TaskRunResponses** (Respuestas del Checklist)

- `task_run` (link ‚Üí TaskRuns)
- `checklist_item` (link ‚Üí ChecklistItems)
- `boolean_value` (boolean) - Para elementos yes/no
- `number_value` (number) - Para n√∫meros/temperaturas
- `text_value` (text) - Para texto libre
- `file_urls` (file multiple) - Para fotos/documentos
- `responded_at` (date) - Fecha/hora respuesta

### **QualityLogs** (Bit√°coras de Calidad)

- `location` (link ‚Üí Locations)
- `user` (link ‚Üí Users) - Responsable del registro
- `type` (single select) - TEMPERATURE, PPM, TDS, PH, PRESSURE, CLEANING
- `value` (number) - Valor medido
- `unit` (text) - Unidad de medida
- `equipment` (text) - Equipo utilizado
- `notes` (text) - Observaciones
- `signed_by` (text) - Firma digital
- `signed_at` (date) - Fecha/hora firma
- `recorded_at` (date) - Fecha/hora registro

## üèõÔ∏è Permisos y Cumplimiento

### **Permits** (Permisos)

- `location` (link ‚Üí Locations)
- `name` (text) - Nombre del permiso
- `authority` (single select) - Uso de Suelo, Salud, Protecci√≥n Civil, etc.
- `permit_number` (text) - N√∫mero oficial
- `status` (single select) - ACTIVE, EXPIRED, PENDING_RENEWAL, SUSPENDED, CANCELED
- `issued_date` (date) - Fecha de emisi√≥n
- `expiry_date` (date) - Fecha de vencimiento
- `documents` (file multiple) - Documentos oficiales
- `notes` (text) - Notas adicionales

### **PermitRenewals** (Renovaciones de Permisos)

- `permit` (link ‚Üí Permits)
- `rrule` (text) - Regla de recurrencia RFC 5545
- `next_due` (date) - Pr√≥xima fecha de renovaci√≥n
- `responsible_user` (link ‚Üí Users) - Responsable
- `active` (boolean) - Estado activo

## üí∞ Facturaci√≥n CFDI

### **InvoicesCFDI** (Facturas CFDI)

- `ticket` (link ‚Üí Tickets)
- `uuid` (text) - UUID del CFDI
- `series` (text) - Serie
- `folio` (text) - Folio
- `rfc` (text) - RFC del cliente
- `name` (text) - Raz√≥n social
- `address` (long text) - Direcci√≥n fiscal
- `xml_file` (file) - Archivo XML
- `pdf_file` (file) - Archivo PDF
- `status` (single select) - PENDING, ISSUED, SENT, PAID, CANCELED, ERROR
- `pac_response` (long text) - Respuesta del PAC (JSON)
- `issued_at` (date) - Fecha de timbrado
- `canceled_at` (date) - Fecha de cancelaci√≥n

## üìä F√≥rmulas y C√°lculos Autom√°ticos

### **Costeo Autom√°tico**

```javascript
// En tabla Recipes, campo cost_calculated
rollup('RecipeIngredients', 'cost_line', 'sum');

// En tabla RecipeIngredients, campo cost_line
field('quantity') * lookup('inventory_item', 'cost_per_unit');
```

### **RFM Segmentation**

```javascript
// En tabla Customers, campo rfm_bucket (f√≥rmula compleja)
if(
  and(field('total_spent') > 1000, field('visit_count') > 10,
      datetime_diff(now(), field('last_visit'), 'days') < 30),
  'Champions',
  if(field('visit_count') < 2, 'New Customers', 'At Risk')
)
```

### **Stock Te√≥rico**

```javascript
// En tabla InventoryItems, campo theoretical_stock
rollup('InventoryMovements', 'quantity', 'sum');
```

### **Margen por Producto**

```javascript
// En tabla Products, campo margin_percent
((field('price') - lookup('recipes', 'cost_calculated')) / field('price')) *
  100;
```

## üîÑ Vistas Predefinidas

### **Dashboard Gerencial**

- **Vista Kanban**: Tickets por status
- **Vista Calendar**: TaskRuns programados
- **Vista Gallery**: Productos con im√°genes

### **Control de Inventario**

- **Vista Grid**: Items con stock < par level (filtrado)
- **Vista Form**: Movimientos de inventario
- **Vista Calendar**: Fechas de vencimiento

### **Calidad y Compliance**

- **Vista Kanban**: TaskRuns por status
- **Vista Calendar**: Renovaciones de permisos
- **Vista Grid**: QualityLogs fuera de rango

## üé® Personalizaci√≥n UI

### **Colores por Categor√≠a**

- üî¥ **Cr√≠tico**: Temperaturas fuera de rango, permisos vencidos
- üü° **Advertencia**: Stock bajo, renovaciones pr√≥ximas
- üü¢ **Normal**: Todo en orden
- üîµ **Informaci√≥n**: Datos de referencia

### **Iconos por M√≥dulo**

- ‚òï **Productos**: Emoji de caf√©
- üì¶ **Inventario**: Emoji de caja
- ‚úÖ **Calidad**: Emoji de check
- üë• **CRM**: Emoji de personas
- üí∞ **Finanzas**: Emoji de dinero

## üîó API Integration

### **Baserow REST API**

```javascript
// Obtener productos activos
GET /api/database/tables/{table_id}/rows/?filters=[{"field":"active","type":"equal","value":"true"}]

// Crear nuevo ticket
POST /api/database/tables/{tickets_table_id}/rows/
{
  "ticket_number": "T-001",
  "location": [location_id],
  "status": "OPEN"
}
```

### **Webhooks Configurados**

- **Ticket Closed** ‚Üí Trigger n8n workflow (NPS, inventory update)
- **Inventory Low** ‚Üí Trigger n8n workflow (reorder alert)
- **Task Run Completed** ‚Üí Trigger n8n workflow (quality notifications)

## üöÄ Setup Inicial

### 1. Crear Base de Datos

1. Acceder a Baserow: http://localhost:8000
2. Crear cuenta admin
3. Crear workspace "CoffeeOS"
4. Importar template de tablas

### 2. Configurar Permisos

1. Crear grupos por rol (Propietario, Gerente, etc.)
2. Asignar permisos por tabla
3. Configurar Row-Level Security

### 3. Importar Datos Iniciales

1. Organizaciones y ubicaciones
2. Usuarios y roles
3. Cat√°logo de productos base
4. Checklists NOM-251
5. Proveedores principales

### 4. Configurar API Token

1. Generar token de API
2. Actualizar .env.local: `BASEROW_TOKEN=your-token`
3. Configurar webhooks

## üìã Checklist de Validaci√≥n

- [ ] ‚úÖ Todas las tablas creadas con campos correctos
- [ ] üîó Relaciones configuradas entre tablas
- [ ] üìä F√≥rmulas de c√°lculo funcionando
- [ ] üé® Vistas personalizadas creadas
- [ ] üîê Permisos por rol configurados
- [ ] üîÑ Webhooks n8n configurados
- [ ] üì° API token generado y validado
- [ ] üìù Datos iniciales importados

## üÜò Troubleshooting

### **Problema**: F√≥rmulas no calculan

**Soluci√≥n**: Verificar que los campos referenciados existan y tengan el tipo correcto

### **Problema**: Permisos no funcionan

**Soluci√≥n**: Revisar configuraci√≥n de grupos y Row-Level Security

### **Problema**: API devuelve errores

**Soluci√≥n**: Validar token y permisos de la tabla espec√≠fica

---

## üìû Soporte

- üìß **Email**: baserow@coffeeos.mx
- üìñ **Docs**: https://baserow.io/docs
- üí¨ **Community**: https://community.baserow.io

---

_Configuraci√≥n Baserow completada - CoffeeOS v1.0.0_
